<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PHANTOM NEURAL DJ v4.0 | SELF-LEARNING AI SYSTEM</title>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@300;600;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        /* --- RESET & VARIABLES --- */
        :root {
            --bg-dark: #05070a;
            --panel-dark: #0f1216;
            --primary: #00f2ff; /* Cyber Cyan */
            --secondary: #7000ff; /* Electric Purple */
            --alert: #ff003c;
            --success: #00ff9d;
            
            --glass: rgba(15, 18, 22, 0.85);
            --border: 1px solid rgba(255, 255, 255, 0.08);
            
            --shadow-glow: 0 0 20px rgba(0, 242, 255, 0.15);
        }

        * { box-sizing: border-box; outline: none; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            width: 100vw; height: 100vh;
            background: var(--bg-dark);
            background-image: 
                radial-gradient(circle at 50% 0%, #1a1a2e 0%, var(--bg-dark) 60%),
                linear-gradient(0deg, rgba(0,0,0,0.8), transparent);
            color: #fff;
            font-family: 'Exo 2', sans-serif;
            overflow: hidden; /* Asla taşma yapma */
            display: flex; flex-direction: column;
        }

        /* --- LAYOUT GRID (Responsive Fix) --- */
        .app-container {
            display: grid;
            grid-template-rows: 60px 1fr 140px; /* Header, Stage, Footer */
            height: 100%; width: 100%;
        }

        /* --- HEADER --- */
        header {
            background: var(--glass);
            backdrop-filter: blur(10px);
            border-bottom: var(--border);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px;
            z-index: 100;
        }

        .brand { font-family: 'Share Tech Mono'; font-size: 24px; letter-spacing: 2px; color: var(--primary); text-shadow: var(--shadow-glow); }
        .brand span { color: #fff; font-weight: 100; opacity: 0.5; font-size: 14px; }

        .ai-stats {
            display: flex; gap: 20px; font-size: 12px; color: #888; font-family: 'Share Tech Mono';
        }
        .stat-box b { color: var(--success); }

        /* --- MAIN STAGE (Center) --- */
        .stage {
            display: flex;
            justify-content: center;
            align-items: stretch;
            padding: 10px;
            gap: 10px;
            overflow: hidden;
            position: relative;
        }

        /* DECK STYLING */
        .deck {
            flex: 1;
            background: linear-gradient(145deg, #15181e, #0a0c0f);
            border-radius: 10px;
            border: var(--border);
            display: flex; flex-direction: column;
            padding: 15px;
            position: relative;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            min-width: 0; /* Flexbox shrink fix */
        }

        .deck.active {
            border-color: var(--primary);
            box-shadow: inset 0 0 30px rgba(0, 242, 255, 0.05);
        }

        .deck-info {
            display: flex; justify-content: space-between; margin-bottom: 10px;
            font-family: 'Share Tech Mono'; color: #555;
        }
        .deck.active .deck-info { color: var(--primary); }

        /* RESPONSIVE TURNTABLE */
        .turntable-wrapper {
            flex: 1;
            display: flex; justify-content: center; align-items: center;
            position: relative;
            min-height: 0; /* Important for flex scaling */
        }

        .vinyl {
            aspect-ratio: 1/1;
            height: 80%; /* Container'a göre ölçeklenir */
            max-height: 300px;
            border-radius: 50%;
            background: repeating-radial-gradient(#111, #111 5px, #1a1a1a 6px);
            border: 4px solid #222;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            display: flex; justify-content: center; align-items: center;
            animation: spin 0s linear infinite; /* JS ile kontrol edilir */
        }
        
        .vinyl-label {
            width: 35%; height: 35%;
            background: var(--secondary);
            border-radius: 50%;
            border: 2px solid #fff;
            opacity: 0.8;
        }

        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* TRACK DISPLAY */
        .lcd-screen {
            background: #000;
            border: 1px solid #333;
            padding: 8px;
            font-family: 'Share Tech Mono';
            color: var(--primary);
            margin-top: 10px;
            border-radius: 4px;
        }
        .track-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 14px; }
        .track-time { display: flex; justify-content: space-between; font-size: 11px; margin-top: 4px; color: #666; }
        .progress-bar { height: 3px; background: #222; margin-top: 5px; width: 100%; }
        .progress-fill { height: 100%; width: 0%; background: var(--primary); transition: width 0.5s linear; }

        /* MIXER (Center Column) */
        .mixer {
            width: 220px;
            background: #0e1014;
            border: var(--border);
            border-radius: 10px;
            display: flex; flex-direction: column;
            padding: 10px;
            gap: 10px;
            min-width: 200px;
        }

        /* AI BRAIN VISUALIZATION */
        .ai-core-display {
            flex: 1;
            background: #000;
            border: 1px solid rgba(0, 242, 255, 0.3);
            border-radius: 6px;
            position: relative;
            overflow: hidden;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        
        .hologram-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0.6;
        }

        .ai-status-msg {
            z-index: 10; font-size: 10px; color: #fff; background: rgba(0,0,0,0.6); padding: 2px 6px;
            border-radius: 4px; letter-spacing: 1px;
        }

        .confidence-meter {
            width: 80%; height: 2px; background: #333; margin-top: 5px; z-index: 10;
        }
        .confidence-val { height: 100%; background: var(--success); width: 0%; transition: width 0.5s; }

        /* CONTROLS */
        .control-group { text-align: center; }
        
        .slider-container {
            width: 100%; padding: 10px 0;
        }
        
        input[type=range] {
            width: 100%; -webkit-appearance: none; background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 30px; width: 15px;
            background: #ccc; border-radius: 2px; cursor: pointer; margin-top: -13px;
            box-shadow: 0 0 10px #fff;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; background: #333; border-radius: 2px;
        }

        .btn-ai-toggle {
            background: rgba(0, 242, 255, 0.1);
            border: 1px solid var(--primary);
            color: var(--primary);
            width: 100%; padding: 8px;
            font-family: 'Exo 2'; font-weight: bold; font-size: 12px;
            cursor: pointer; border-radius: 4px;
            transition: 0.3s;
        }
        .btn-ai-toggle.active { background: var(--primary); color: #000; box-shadow: 0 0 15px var(--primary); }

        /* --- FOOTER (Library) --- */
        footer {
            background: #080a0d;
            border-top: var(--border);
            display: flex;
            padding: 0;
            overflow: hidden;
        }

        .library-panel {
            flex: 1; display: flex; flex-direction: column;
        }
        
        .input-bar {
            padding: 10px; display: flex; gap: 10px; background: #0f1216; border-bottom: 1px solid #222;
        }
        
        input[type="text"] {
            flex: 1; background: #1a1d24; border: 1px solid #333; color: #fff; padding: 8px;
            font-family: 'Share Tech Mono';
        }
        
        .btn-add { background: #333; color: #fff; border: none; padding: 0 20px; cursor: pointer; font-weight: bold; }
        .btn-add:hover { background: #fff; color: #000; }

        .queue-list {
            flex: 1; overflow-y: hidden; overflow-x: auto;
            display: flex; gap: 10px; padding: 15px;
            align-items: center;
        }

        .track-card {
            min-width: 160px; height: 90px;
            background: #15181e; border: 1px solid #333; border-radius: 6px;
            padding: 10px; cursor: pointer;
            display: flex; flex-direction: column; justify-content: space-between;
            position: relative; transition: 0.2s;
        }
        .track-card:hover { border-color: #666; background: #1a1d24; }
        .track-card.suggestion { border-color: var(--secondary); box-shadow: 0 0 10px rgba(112, 0, 255, 0.2); }
        .suggestion-badge { 
            position: absolute; top: -8px; right: -8px; background: var(--secondary); 
            font-size: 9px; padding: 2px 6px; border-radius: 10px; color: #fff;
        }

        /* OVERLAY START */
        #start-overlay {
            position: fixed; inset: 0; background: #000; z-index: 999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .big-btn {
            font-size: 24px; padding: 20px 60px;
            background: transparent; color: var(--primary); border: 2px solid var(--primary);
            font-family: 'Share Tech Mono'; letter-spacing: 4px; cursor: pointer;
            margin-top: 30px; transition: 0.3s;
        }
        .big-btn:hover { background: var(--primary); color: #000; box-shadow: 0 0 30px var(--primary); }

        /* UTILS */
        .hidden { display: none; }
        
        /* MOBILE TWEAKS */
        @media (max-width: 768px) {
            .app-container { grid-template-rows: 50px 1fr 120px; }
            .stage { flex-direction: column; overflow-y: auto; }
            .mixer { width: 100%; height: 150px; flex-direction: row; min-height: unset; flex-shrink: 0; }
            .deck { flex-shrink: 0; min-height: 250px; }
            .ai-core-display { display: none; } /* Mobilede AI ekranını gizle, yer kazanalım */
            .vinyl { height: 60%; }
        }
    </style>
</head>
<body>

    <div id="start-overlay">
        <h1 style="color:#fff; font-size:40px; margin:0; text-shadow:0 0 20px var(--primary);">PHANTOM DJ</h1>
        <p style="color:#666; font-family:monospace;">NEURAL NETWORK V4.0 INITIALIZED</p>
        <button class="big-btn" onclick="SYSTEM.init()">SİSTEMİ BAŞLAT</button>
    </div>

    <div class="app-container">
        <header>
            <div class="brand">NEURAL<span>CORE</span></div>
            <div class="ai-stats">
                <div class="stat-box">MEMORY: <b id="mem-count">0</b> PATTERNS</div>
                <div class="stat-box">XP LEVEL: <b id="xp-level">1</b></div>
            </div>
        </header>

        <div class="stage">
            
            <div class="deck active" id="deck-A">
                <div class="deck-info">
                    <span>DECK A</span>
                    <span id="status-A">READY</span>
                </div>
                <div class="turntable-wrapper">
                    <div class="vinyl" id="vinyl-A"><div class="vinyl-label"></div></div>
                </div>
                <div class="lcd-screen">
                    <div class="track-name" id="title-A">NO MEDIA</div>
                    <div class="track-time">
                        <span id="curr-A">00:00</span>
                        <span id="rem-A">-00:00</span>
                    </div>
                    <div class="progress-bar"><div class="progress-fill" id="fill-A"></div></div>
                </div>
            </div>

            <div class="mixer">
                <div class="ai-core-display">
                    <canvas id="brain-canvas" class="hologram-canvas"></canvas>
                    <div class="ai-status-msg" id="ai-msg">AI STANDBY</div>
                    <div class="confidence-meter"><div class="confidence-val" id="ai-conf"></div></div>
                </div>

                <div class="control-group">
                    <button class="btn-ai-toggle active" id="btn-autopilot" onclick="AI.toggle()">
                        AUTOPILOT: ON
                    </button>
                </div>

                <div class="control-group" style="margin-top: auto;">
                    <div style="font-size: 10px; color: #666; margin-bottom: 5px;">CROSSFADER</div>
                    <div class="slider-container">
                        <input type="range" min="0" max="100" value="0" id="crossfader" oninput="AUDIO.manualCrossfade(this.value)">
                    </div>
                    <div style="display:flex; justify-content:space-between; font-size:10px; color:#444; padding:0 5px;">
                        <span>A</span><span>B</span>
                    </div>
                </div>
            </div>

            <div class="deck" id="deck-B">
                <div class="deck-info">
                    <span>DECK B</span>
                    <span id="status-B">WAITING</span>
                </div>
                <div class="turntable-wrapper">
                    <div class="vinyl" id="vinyl-B"><div class="vinyl-label" style="background:var(--primary);"></div></div>
                </div>
                <div class="lcd-screen">
                    <div class="track-name" id="title-B">NO MEDIA</div>
                    <div class="track-time">
                        <span id="curr-B">00:00</span>
                        <span id="rem-B">-00:00</span>
                    </div>
                    <div class="progress-bar"><div class="progress-fill" id="fill-B"></div></div>
                </div>
            </div>

        </div>

        <footer>
            <div class="library-panel">
                <div class="input-bar">
                    <input type="text" id="yt-input" placeholder="YouTube Linki Yapıştır...">
                    <button class="btn-add" onclick="LIBRARY.addFromInput()">EKLE</button>
                    <button class="btn-add" style="background:#222; color:#888;" onclick="toggleFullScreen()">[ ]</button>
                </div>
                <div class="queue-list" id="queue-box">
                    </div>
            </div>
        </footer>
    </div>

    <div id="player-A" class="hidden"></div>
    <div id="player-B" class="hidden"></div>

    <script>
        /* --- GLOBAL HELPERS --- */
        const $ = (id) => document.getElementById(id);
        function toggleFullScreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(e=>{});
            else if (document.exitFullscreen) document.exitFullscreen();
        }

        /* --- 1. NEURAL CORE (PERSISTENT MEMORY) --- */
        const MEMORY = {
            data: {
                patterns: {}, // { "SongID_A": { "SongID_B": count } }
                xp: 0,
                totalMixes: 0
            },
            
            load: function() {
                const stored = localStorage.getItem('DJ_NEURAL_V4');
                if (stored) this.data = JSON.parse(stored);
                this.updateUI();
            },

            save: function() {
                localStorage.setItem('DJ_NEURAL_V4', JSON.stringify(this.data));
                this.updateUI();
            },

            learnConnection: function(fromId, toId) {
                if(!fromId || !toId || fromId === toId) return;
                
                if(!this.data.patterns[fromId]) this.data.patterns[fromId] = {};
                if(!this.data.patterns[fromId][toId]) this.data.patterns[fromId][toId] = 0;
                
                this.data.patterns[fromId][toId]++;
                this.data.totalMixes++;
                this.data.xp += 10; // XP Gain
                
                this.save();
                console.log(`[NEURAL] Learned connection: ${fromId} -> ${toId}`);
            },

            getBestNextTrack: function(currentId, availableQueue) {
                // Mevcut şarkıdan sonra en çok çalınan şarkıyı bul
                const knowledge = this.data.patterns[currentId];
                if (!knowledge) return null;

                // Knowledge içindeki en yüksek puanlı ID'yi bul
                let bestId = null;
                let maxScore = -1;
                
                for (const [nextId, score] of Object.entries(knowledge)) {
                    if (score > maxScore) {
                        maxScore = score;
                        bestId = nextId;
                    }
                }

                // Bu ID kuyrukta var mı?
                return availableQueue.find(track => track.id === bestId);
            },

            updateUI: function() {
                const patternCount = Object.keys(this.data.patterns).length;
                const level = Math.floor(this.data.xp / 100) + 1;
                $('mem-count').innerText = patternCount;
                $('xp-level').innerText = level;
            }
        };

        /* --- 2. AI CONTROLLER --- */
        const AI = {
            active: true,
            confidence: 0,
            lastActionTime: 0,
            
            toggle: function() {
                this.active = !this.active;
                $('btn-autopilot').className = this.active ? 'btn-ai-toggle active' : 'btn-ai-toggle';
                $('btn-autopilot').innerText = this.active ? 'AUTOPILOT: ON' : 'AUTOPILOT: OFF';
                $('ai-msg').innerText = this.active ? 'AI RESUMED' : 'MANUAL CONTROL';
            },

            think: function() {
                if (!this.active) return;
                
                const activeDeck = AUDIO.activeDeck;
                const activePlayer = AUDIO.players[activeDeck];
                if (!activePlayer || !activePlayer.getDuration) return;

                const duration = activePlayer.getDuration();
                const current = activePlayer.getCurrentTime();
                const remaining = duration - current;
                
                // Visual Updates
                this.updateHologram(remaining);

                // LOGIC GATES
                
                // 1. Prepare Next Track (30s remaining)
                if (remaining < 30 && remaining > 25) {
                    const standby = activeDeck === 'A' ? 'B' : 'A';
                    if (AUDIO.deckStates[standby] === 'EMPTY') {
                        $('ai-msg').innerText = "SELECTING NEXT TRACK...";
                        LIBRARY.loadSmartTrack(standby);
                    }
                }

                // 2. Sync & Buffer (15s remaining)
                if (remaining < 15 && remaining > 10) {
                    const standby = activeDeck === 'A' ? 'B' : 'A';
                    if (AUDIO.deckStates[standby] !== 'PLAYING') {
                        $('ai-msg').innerText = "BEATMATCHING...";
                        AUDIO.playDeck(standby, 0); // Play silent
                    }
                }

                // 3. EXECUTE MIX (Random logic based on 'Confidence')
                // Basic: If < 10s, mix.
                if (remaining < 10 && remaining > 0 && !AUDIO.isMixing) {
                    $('ai-msg').innerText = "EXECUTING TRANSITION";
                    AUDIO.autoMix(activeDeck === 'A' ? 'B' : 'A');
                    
                    // Learn Pattern
                    const prevTrack = AUDIO.currentTracks[activeDeck];
                    const nextTrack = AUDIO.currentTracks[activeDeck === 'A' ? 'B' : 'A'];
                    if(prevTrack && nextTrack) {
                        MEMORY.learnConnection(prevTrack.id, nextTrack.id);
                    }
                }
            },

            updateHologram: function(remaining) {
                // Fake confidence calculation based on time
                if (remaining > 30) this.confidence = 90 + Math.random() * 10;
                else if (remaining > 10) this.confidence = 70 + Math.random() * 20;
                else this.confidence = 40 + Math.random() * 50; // Panic mode

                $('ai-conf').style.width = this.confidence + "%";
                
                if (AUDIO.isMixing) {
                    $('ai-conf').style.backgroundColor = "var(--secondary)";
                    $('ai-msg').innerText = "MIXING IN PROGRESS...";
                } else {
                    $('ai-conf').style.backgroundColor = "var(--success)";
                }
            }
        };

        /* --- 3. LIBRARY SYSTEM --- */
        const LIBRARY = {
            queue: [
                { id: 'lTRiuFIWV54', title: 'Ibiza Summer Mix 2024' },
                { id: '5r3B7yL2sC0', title: 'Deep House Relax' },
                { id: 'jfKfPfyJRdk', title: 'Lofi Hip Hop Radio' },
                { id: '7nos6lNMulo', title: 'Club Hits 2025' }
            ],

            init: function() {
                this.renderQueue();
            },

            addFromInput: function() {
                const val = $('yt-input').value;
                let id = '';
                if (val.includes('v=')) id = val.split('v=')[1].split('&')[0];
                else if (val.includes('youtu.be/')) id = val.split('youtu.be/')[1];
                else id = val; // Try direct ID

                if (id.length > 5) {
                    this.queue.push({ id: id, title: 'User Track ' + Math.floor(Math.random()*100) });
                    $('yt-input').value = '';
                    this.renderQueue();
                }
            },

            renderQueue: function() {
                const container = $('queue-box');
                container.innerHTML = '';
                
                // Get AI Suggestion based on current playing track
                const currentTrackId = AUDIO.currentTracks[AUDIO.activeDeck]?.id;
                const smartPick = MEMORY.getBestNextTrack(currentTrackId, this.queue);

                this.queue.forEach((track, idx) => {
                    const div = document.createElement('div');
                    div.className = 'track-card';
                    if (smartPick && smartPick.id === track.id) {
                        div.classList.add('suggestion');
                        div.innerHTML += `<span class="suggestion-badge">AI PICK</span>`;
                    }
                    div.innerHTML += `
                        <div style="font-size:11px; color:#888;">#${idx+1}</div>
                        <div style="font-size:12px; font-weight:bold; overflow:hidden;">${track.title}</div>
                    `;
                    div.onclick = () => this.forceLoad(track);
                    container.appendChild(div);
                });
            },

            loadSmartTrack: function(deckId) {
                if (this.queue.length === 0) return;
                
                const currentTrackId = AUDIO.currentTracks[AUDIO.activeDeck === 'A' ? 'B' : 'A']?.id; // Other deck
                let pick = MEMORY.getBestNextTrack(currentTrackId, this.queue);
                
                // If no smart pick or same as playing, pick random but not same
                if (!pick) {
                    pick = this.queue[Math.floor(Math.random() * this.queue.length)];
                }

                AUDIO.loadTrack(deckId, pick);
            },

            forceLoad: function(track) {
                // Load to the inactive deck
                const target = AUDIO.activeDeck === 'A' ? 'B' : 'A';
                AUDIO.loadTrack(target, track);
            }
        };

        /* --- 4. AUDIO ENGINE --- */
        const AUDIO = {
            players: { A: null, B: null },
            activeDeck: 'A',
            isMixing: false,
            deckStates: { A: 'EMPTY', B: 'EMPTY' }, // EMPTY, LOADED, PLAYING
            currentTracks: { A: null, B: null },
            crossfader: 0,

            init: function() {
                // Players created by YouTube API callback
            },

            loadTrack: function(deck, track) {
                if (!this.players[deck]) return;
                
                this.currentTracks[deck] = track;
                this.players[deck].loadVideoById(track.id);
                this.players[deck].pauseVideo(); // Start paused
                
                $(`title-${deck}`).innerText = track.title;
                $(`status-${deck}`).innerText = "LOADED";
                this.deckStates[deck] = 'LOADED';
                
                // Reset Visuals
                $(`vinyl-${deck}`).style.animation = "none";
            },

            playDeck: function(deck, volume = 100) {
                if (!this.players[deck]) return;
                this.players[deck].playVideo();
                this.players[deck].setVolume(volume);
                this.deckStates[deck] = 'PLAYING';
                $(`deck-${deck}`).classList.add('active');
                $(`vinyl-${deck}`).style.animation = "spin 2s linear infinite";
            },

            stopDeck: function(deck) {
                 if (!this.players[deck]) return;
                 // Don't stop completely to avoid buffering if we need it back, just pause
                 this.players[deck].pauseVideo(); 
                 this.deckStates[deck] = 'LOADED';
                 $(`deck-${deck}`).classList.remove('active');
                 $(`vinyl-${deck}`).style.animation = "none";
            },

            manualCrossfade: function(val) {
                // val: 0 (A) to 100 (B)
                this.isMixing = true; // User intervention
                this.applyCrossfade(val);
                
                if (val == 0) this.activeDeck = 'A';
                if (val == 100) this.activeDeck = 'B';
            },

            autoMix: function(targetDeck) {
                this.isMixing = true;
                const start = parseInt($('crossfader').value);
                const end = targetDeck === 'B' ? 100 : 0;
                const duration = 6000; // 6 seconds mix
                const steps = 60;
                
                let step = 0;
                const interval = setInterval(() => {
                    step++;
                    const progress = step / steps;
                    const val = start + (end - start) * progress;
                    
                    $('crossfader').value = val;
                    this.applyCrossfade(val);

                    if (step >= steps) {
                        clearInterval(interval);
                        this.finishMix(targetDeck);
                    }
                }, duration / steps);
            },

            applyCrossfade: function(val) {
                // Equal Power Logic
                const ratio = val / 100;
                const volA = Math.cos(ratio * 0.5 * Math.PI) * 100;
                const volB = Math.cos((1 - ratio) * 0.5 * Math.PI) * 100;

                if (this.players.A) this.players.A.setVolume(volA);
                if (this.players.B) this.players.B.setVolume(volB);
            },

            finishMix: function(winnerDeck) {
                this.isMixing = false;
                this.activeDeck = winnerDeck;
                const loserDeck = winnerDeck === 'A' ? 'B' : 'A';
                
                this.stopDeck(loserDeck);
                $(`deck-${winnerDeck}`).classList.add('active');
                $(`status-${winnerDeck}`).innerText = "ON AIR";
            },

            updateLoop: function() {
                // Updates timers and progress bars
                ['A', 'B'].forEach(d => {
                    const p = this.players[d];
                    if (p && p.getDuration) {
                        const dur = p.getDuration();
                        const curr = p.getCurrentTime();
                        if (dur > 0) {
                            $(`fill-${d}`).style.width = ((curr / dur) * 100) + "%";
                            $(`curr-${d}`).innerText = this.fmtTime(curr);
                            $(`rem-${d}`).innerText = "-" + this.fmtTime(dur - curr);
                        }
                    }
                });
            },

            fmtTime: function(s) {
                const m = Math.floor(s / 60);
                const sec = Math.floor(s % 60);
                return `${m}:${sec<10?'0'+sec:sec}`;
            }
        };

        /* --- 5. INITIALIZATION SEQUENCE --- */
        const SYSTEM = {
            init: function() {
                $('start-overlay').style.display = 'none';
                MEMORY.load();
                LIBRARY.init();
                
                // Force Audio Context unlock
                // (Browser policy requires user interaction first)
                
                // Load First Track
                LIBRARY.loadSmartTrack('A');
                setTimeout(() => AUDIO.playDeck('A'), 1000);
                
                // Start Brain Loop
                setInterval(() => AI.think(), 1000);
                setInterval(() => AUDIO.updateLoop(), 500);
                
                // Start Hologram Visualizer
                this.startHologram();
            },

            startHologram: function() {
                const canvas = $('brain-canvas');
                const ctx = canvas.getContext('2d');
                
                // Resize handling
                const resize = () => {
                    canvas.width = canvas.parentElement.offsetWidth;
                    canvas.height = canvas.parentElement.offsetHeight;
                };
                window.onresize = resize;
                resize();

                // Animation Loop
                const draw = () => {
                    ctx.fillStyle = 'rgba(0,0,0,0.1)';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    ctx.strokeStyle = AUDIO.isMixing ? '#7000ff' : '#00f2ff';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    
                    const centerY = canvas.height / 2;
                    const amplitude = AUDIO.isMixing ? 50 : 20;
                    
                    for (let x = 0; x < canvas.width; x++) {
                        // Simulated waveform based on random + time
                        const y = centerY + Math.sin(x * 0.05 + Date.now() * 0.01) * amplitude * Math.random();
                        ctx.lineTo(x, y);
                    }
                    ctx.stroke();
                    requestAnimationFrame(draw);
                };
                draw();
            }
        };

        /* --- YOUTUBE IFRAME API --- */
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        function onYouTubeIframeAPIReady() {
            AUDIO.players.A = new YT.Player('player-A', { height: '1', width: '1', videoId: '' });
            AUDIO.players.B = new YT.Player('player-B', { height: '1', width: '1', videoId: '' });
        }

    </script>
</body>
</html>
